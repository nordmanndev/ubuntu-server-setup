name: Continuous Integration

# Enable Buildkit and let compose use it to speed up image building
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  TERM: screen-256color

on:
  pull_request:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

  push:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

jobs:
  # runs all of the steps inside the specified container rather than on the VM host.
  # Because of this the network configuration changes from host based network to a container network.
  test:

    runs-on: ubuntu-20.04

    strategy:
      matrix:
        container: ["ubuntu:focal", "ubuntu:bionic"]

    container:
      image: ${{ matrix.container }}

    steps:
      - name: Checkout Code Repository
        uses: actions/checkout@v2
        # Use https (public access) instead of git for git-submodules.
        with:
          submodules: false

      - name: Setup Submodules
        run: |
          # use sed to replace the SSH URL with the public URL, then init and update submodules
          sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
          git submodule update --init --recursive

      - name: Run tests
        shell: bash
        run: |
          bash -c 'shopt -s globstar; shellcheck ./*.sh; shellcheck ./tests/*.sh'
          bash tests/unit-tests.sh -skip
